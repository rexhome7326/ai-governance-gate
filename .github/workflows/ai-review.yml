name: AI Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read

    env:
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      SCAN_DIR: src
      SHEET_API_URL: ${{ secrets.SHEET_API_URL }}
      SHEET_API_TOKEN: ${{ secrets.SHEET_API_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Extract UUID
        id: uuid
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          UUID=$(echo "$TITLE" | grep -oE '[a-f0-9-]{36}' | head -1 || true)
          UUID="${UUID:-}"
          echo "uuid=$UUID" >> $GITHUB_OUTPUT

      - name: Find ZIPs
        id: zip
        run: |
          ZIP=$(ls scan-targets/*.zip | head -n 10 | tr '\n' ' ')
          echo "zip=$ZIP" >> $GITHUB_OUTPUT

      - name: Unzip
        run: |
          mkdir -p ${{ env.SCAN_DIR }} reports
          for z in ${{ steps.zip.outputs.zip }}; do
            echo "Unzipping $z"
            unzip -o "$z" -d ${{ env.SCAN_DIR }}
          done

      - name: Verify Source
        run: |
          echo "Source tree:"
          find ${{ env.SCAN_DIR }} -type f | head -n 50

      - name: Check source
        id: check_source
        env:
          UUID: ${{ steps.uuid.outputs.uuid }}
        run: |
          HAS_FILES=false
          if [ -n "$(find ${{ env.SCAN_DIR }} -type f 2>/dev/null | head -1)" ]; then
            HAS_FILES=true
          fi
          echo "has_files=$HAS_FILES" >> $GITHUB_OUTPUT

          RUN_SCANS=false
          if [ "$HAS_FILES" = true ] && [ -n "$UUID" ]; then
            RUN_SCANS=true
          fi
          echo "run_scans=$RUN_SCANS" >> $GITHUB_OUTPUT

      # --------------------
      # CodeQL
      # --------------------
      - name: Init CodeQL
        if: steps.check_source.outputs.run_scans == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
          source-root: ${{ env.SCAN_DIR }}

      - name: Run CodeQL
        if: steps.check_source.outputs.run_scans == 'true'
        uses: github/codeql-action/analyze@v4
        with:
          output: reports

      - name: Copy CodeQL SARIF
        if: steps.check_source.outputs.run_scans == 'true'
        run: cp reports/javascript.sarif reports/codeql.sarif

      - name: Create empty CodeQL SARIF
        if: steps.check_source.outputs.run_scans != 'true'
        run: |
          echo '{"$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif/master/schemata/sarif-schema-2.1.0.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"CodeQL","rules":[]}},"results":[]}]}' > reports/codeql.sarif

      # --------------------
      # Install Semgrep
      # --------------------
      - name: Install Semgrep
        if: steps.check_source.outputs.run_scans == 'true'
        run: pip install semgrep

      # --------------------
      # Semgrep
      # --------------------
      - name: Run Semgrep
        if: steps.check_source.outputs.run_scans == 'true'
        run: |
          semgrep scan src --config=.github/scripts/semgrep.yml --json > reports/semgrep.json

      - name: Create empty Semgrep JSON
        if: steps.check_source.outputs.run_scans != 'true'
        run: echo '{"results":[]}' > reports/semgrep.json

      # --------------------
      # Gemini AI Scan
      # --------------------
      - name: Gemini Scan
        if: steps.check_source.outputs.run_scans == 'true'
        run: node .github/scripts/gemini_scan.js
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Create empty Gemini JSON
        if: steps.check_source.outputs.run_scans != 'true'
        run: echo '{"engine":"gemini","summary":"No source to scan","severity":"low","details":[]}' > reports/gemini.json

      # --------------------
      # OpenAI Scan (optional)
      # --------------------
      - name: OpenAI Scan
        if: steps.check_source.outputs.run_scans == 'true'
        run: node .github/scripts/openai_scan.js
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Create empty OpenAI JSON
        if: steps.check_source.outputs.run_scans != 'true'
        run: echo '{"engine":"openai","summary":"No source to scan","severity":"low","details":[]}' > reports/openai.json

      # --------------------
      # Score Results
      # --------------------
      - name: Score Results
        run: node .github/scripts/score.js

      # --------------------
      # Export Score to env
      # --------------------
      - name: Export Score
        run: |
          CODEQL=$(jq -r .codeql reports/score.json)
          SEMGREP=$(jq -r .semgrep reports/score.json)
          GEMINI=$(jq -r .gemini reports/score.json)
          OPENAI=$(jq -r .openai reports/score.json)
          AVG=$(jq -r .avg reports/score.json)
          VERDICT=$(jq -r .verdict reports/score.json)

          echo "CODEQL=$CODEQL" >> $GITHUB_ENV
          echo "SEMGREP=$SEMGREP" >> $GITHUB_ENV
          echo "GEMINI=$GEMINI" >> $GITHUB_ENV
          echo "OPENAI=$OPENAI" >> $GITHUB_ENV
          echo "AVG=$AVG" >> $GITHUB_ENV
          echo "VERDICT=$VERDICT" >> $GITHUB_ENV

          if [[ "$VERDICT" == *"PASS"* ]]; then
            echo "TOTAL=PASS" >> $GITHUB_ENV
          else
            echo "TOTAL=FAIL" >> $GITHUB_ENV
          fi

      # --------------------
      # Build Report
      # --------------------
      - name: Build Report
        run: node .github/scripts/build_report.js

      # --------------------
      # Upload Report Artifact
      # --------------------
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-report
          path: reports/

      # --------------------
      # Notify Sheet
      # --------------------
      - name: Update Sheet
        if: steps.check_source.outputs.run_scans == 'true'
        env:
          API: ${{ secrets.SHEET_API_URL }}
          TOKEN: ${{ secrets.SHEET_API_TOKEN }}
          UUID: ${{ steps.uuid.outputs.uuid }}
        run: |
          BODY="{
            \"token\": \"$TOKEN\",
            \"action\": \"update\",
            \"uuid\": \"$UUID\",
            \"patch\": {
              \"6\": \"SCANNED\",
              \"8\": \"${CODEQL}\",
              \"9\": \"${SEMGREP}\",
              \"10\": \"${GEMINI}\",
              \"11\": \"${TOTAL}\",
              \"12\": \"${AVG} (${VERDICT})\"
            }
          }"

          echo "=== curl 目標 ==="
          echo "URL: $API"
          echo "Method: POST"
          echo ""
          echo "=== Header ==="
          echo "Content-Type: application/json"
          echo ""
          echo "=== Body ==="
          echo "$BODY"
          echo ""

          curl -X POST "$API" \
            -H "Content-Type: application/json" \
            -d "$BODY"
